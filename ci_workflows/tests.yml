# run precommit + pytest

precommits:
  stage: test
  tags:
    - cit
  image: bilbydev/bilby_pipe-test-suite-python37
  script:
    - source activate python37
    - mkdir -p .pip37
    - pip install --upgrade pip
    - pip --cache-dir=.pip37 install --upgrade bilby
    - pip --cache-dir=.pip37 install .
    - pip --cache-dir=.pip37 install pre-commit
    # Run precommits (black, flake8, spellcheck, isort, no merge conflicts, etc)
    - pre-commit run --all-files --verbose --show-diff-on-failure


pytest:
  stage: test
  tags:
    - cit
  image: bilbydev/bilby_pipe-test-suite-python37
  script:
    - source activate python37
    - mkdir -p .pip37
    - pip --cache-dir=.pip37 install .[testing]
    # Install a functioning version of dynesty
    - pip --cache-dir=.pip37 install git+https://github.com/joshspeagle/dynesty.git@d16e716e1791efab859349d0363aff9fd8af88fa
    # Run tests and collect coverage data
    - pytest --cov parallel_bilby
    - mpirun -n 4 python -m pytest -s -k end2end --with-mpi
    - coverage html
    - coverage-badge -o coverage_badge.svg -f

  artifacts:
    paths:
      - htmlcov/
      - coverage_badge.svg
