# run precommit + pytest

precommits:
  stage: test
  tags:
    - cit
  image: containers.ligo.org/lscsoft/bilby/v2-bilby-python38
  script:
    - source activate python38
    - mkdir -p .pip38
    - pip install --upgrade pip
    - pip --cache-dir=.pip38 install --upgrade bilby
    - pip --cache-dir=.pip38 install .
    - pip --cache-dir=.pip38 install pre-commit
    # Run precommits (black, flake8, spellcheck, isort, no merge conflicts, etc)
    - pre-commit run --all-files --verbose --show-diff-on-failure


pytest:
  stage: test
  tags:
    - cit
  image: containers.ligo.org/lscsoft/bilby/v2-bilby-python38
  script:
    - source activate python38
    - mkdir -p .pip38
    - pip --cache-dir=.pip38 install .
    # Run tests and collect coverage data
    - pytest --cov parallel_bilby
    - coverage html
    - coverage-badge -o coverage_badge.svg -f

  artifacts:
    paths:
      - htmlcov/
      - coverage_badge.svg
